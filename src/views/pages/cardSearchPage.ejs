<%- include('../partials/header') %>

<main class="container">
  <%- include('../partials/navbar') %>

  <a href="/lista" id="floating-list-button">
    <span class="list-icon">üìù</span>
    <span class="list-item-count hidden">0</span>
  </a>

  <h1>Explorar Cartas de One Piece</h1>

  <div class="search-container">
    <aside class="filters">
      <h3>Filtros</h3>
      <form action="/cards" method="GET">
        <% if (filterGroups && filterGroups.length > 0) { %>
          <% filterGroups.forEach(group => { %>
            <div class="filter-group">
              <h4 class="filter-toggle"><%= group.name %></h4>
              <div class="filter-options" hidden>
              <% group.options.forEach(option => { 
                   const value = typeof option === 'object' ? option.value : option;
                   const label = typeof option === 'object' ? option.label : option;
                   const checked = (filters && filters[group.key] === value) ? 'checked' : '';
              %>
                <label>
                  <input type="radio" name="<%= group.key %>" value="<%= value %>" <%= checked %> onchange="this.form.submit()" />
                  <%= label %>
                </label>
              <% }) %>
              </div>
            </div>
          <% }) %>
        <% } %>

        <!-- Campo de busca opcional -->
        <input type="search" name="q" placeholder="Buscar por nome" value="<%= filters && filters.q ? filters.q : '' %>" />
        <button type="submit" class="btn-primary">Buscar</button>
        <a href="/cards" class="btn-secondary">Limpar Filtros</a>
      </form>
    </aside>

    <section class="results">
      <div class="cards-grid">
        <% if (cards && cards.length > 0) { %>
          <% cards.forEach(card => { %>
            <div class="card-item">
              <a href="/card/<%= card._id %>" class="card-link">
                <div class="card-image-container">
                  <img src="<%= card.image_url %>" alt="<%= card.name %>">
                </div>
                <h4><%= card.name %></h4>
                <p>
                  Pre√ßo M√©dio: <%= card.averagePrice ? formatPrice(card.averagePrice) : 'N/A' %>
                  <% if (card.price_trend === 'up') { %>
                    <span style="color: green; font-size: 1.5em;">‚ñ≤</span>
                  <% } else if (card.price_trend === 'down') { %>
                    <span style="color: red; font-size: 1.5em;">‚ñº</span>
                  <% } else { %>
                    <span style="color: #555; font-size: 1.5em;">‚Üí</span>
                  <% } %>
                </p>
              </a>
              <div class="add-to-list-controls">
                <div class="quantity-selector">
                  <button class="quantity-btn minus" type="button">-</button>
                  <input type="number" class="quantity-input" value="1" min="1">
                  <button class="quantity-btn plus" type="button">+</button>
                </div>
                <button class="add-to-list-btn" data-cardid="<%= card._id %>">+ Lista</button>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p>Nenhuma carta encontrada com esses filtros.</p>
        <% } %>
      </div>

      <% if (totalCards > 0) { 
           const params = new URLSearchParams(filters || {});
           const filterQueryString = params.toString();
      %>
        <div class="pagination">
          <% if (currentPage > 1) { %>
            <a href="/cards?p=<%= currentPage - 1 %>&<%= filterQueryString %>" class="btn-secondary">&larr; P√°gina anterior</a>
          <% } else { %>
            <div></div>
          <% } %>

          <% if (hasMore) { %>
            <a href="/cards?p=<%= currentPage + 1 %>&<%= filterQueryString %>" class="btn-primary">Pr√≥xima p√°gina &rarr;</a>
          <% } %>
        </div>
      <% } %>
    </section>
  </div>
</main>
<script src="/js/main.js"></script>
<script src="/js/card-actions.js" defer></script>
<script src="/js/list.js" defer></script>
<script src="/js/cardSearch.js" defer></script>
<script src="/js/accordion-filters.js"></script>
<%- include('../partials/footer') %>
