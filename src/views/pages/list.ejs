<!DOCTYPE html>
<html lang="pt-br">
<head>
    <%- include('../partials/header') %>
    <title>Minha Lista - CardHub</title>
</head>
<body>
    <%- include('../partials/navbar') %>

    <main class="container">
        <h1>Minha Lista de Compras</h1>

        <% if (wantList && wantList.length > 0) { %>
            <div class="optimizer-panel">
                <!-- Filtros de otimização -->
                <div class="form-group">
                    <label for="max-shops-select">Qtd. Máxima de Lojas</label>
                    <select id="max-shops-select" class="form-control">
                        <option value="99">Sem limitar</option>
                        <option value="1">Até 1 loja</option>
                        <option value="2">Até 2 lojas</option>
                        <option value="3">Até 3 lojas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="state-select">Estado (UF)</label>
                    <select id="state-select" class="form-control">
                        <option value="">Todos</option>
                        <option value="SP">São Paulo</option>
                        <option value="RJ">Rio de Janeiro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="city-input">Cidade</label>
                    <input type="text" id="city-input" class="form-control" placeholder="Digite uma cidade">
                </div>
                <div class="form-group">
                    <label for="min-rating-select">Avaliação Mínima</label>
                    <select id="min-rating-select" class="form-control">
                        <option value="0">Qualquer Avaliação</option>
                        <option value="4">4+ estrelas</option>
                    </select>
                </div>
                <button id="optimize-list-btn" class="btn-primary">⚡ Otimizar</button>
            </div>

            <!-- Adicionar mais cartas à lista -->
            <button id="add-more-cards-btn" class="btn-secondary" style="margin-bottom: 1.5rem;">+ Adicionar mais cartas à lista</button>

            <div class="want-list-container">
                <% wantList.forEach(item => { %>
                    <div class="want-list-item">
                        <div class="card-summary">
                            <img src="<%= item.card.image_url %>" alt="<%= item.card.name %>" class="summary-img">
                            <div class="summary-info">
                                <h3><%= item.card.name %></h3>
                                <p><%= item.card.set_name || 'N/A' %></p>
                                <span>Quantidade desejada: <strong><%= item.quantityWanted %></strong></span>
                            </div>
                            <div class="summary-price">
                                <span>A partir de</span>
                                <strong>R$ <%= item.lowestPrice ? item.lowestPrice.toFixed(2) : 'N/A' %></strong>
                            </div>
                            <button class="toggle-sellers-btn" data-target="sellers-<%= item.card._id %>">
                                Ver Vendedores <span>▼</span>
                            </button>
                            <button class="remove-from-list-btn" data-cardid="<%= item.card._id %>" title="Remover da lista">&times;</button>
                        </div>

                        <!-- Painel de vendedores -->
                        <div class="sellers-drawer" id="sellers-<%= item.card._id %>">
                            <div class="seller-filters">
                                <select class="item-filter-select form-control" data-filter="condition">
                                    <option value="N">Novo</option>
                                    <option value="NM">Praticamente Nova</option>
                                    <option value="NM">Near Mint</option>
                                    <option value="LP">Lightly Played</option>
                                </select>
                                <select class="item-filter-select form-control" data-filter="language">
                                    <option value="">Idioma</option>
                                    <option value="pt">Português</option>
                                    <option value="en">Inglês</option>
                                </select>
                                <select class="item-filter-select form-control" data-filter="is_foil">
                                    <option value="">Todos</option>
                                    <option value="false">Normal</option>
                                    <option value="true">Foil</option>
                                </select>
                            </div>

                            <div class="listings-container">
                                <% if (item.listings.length > 0) { %>
                                    <% item.listings.forEach(listing => { %>
                                        <div class="listing-row">
                                            <div class="seller-info">
                                                <strong><%= listing.seller.username %></strong>
                                                <% if (listing.seller.accountType === 'shop') { %>
                                                    <span class="shop-badge">LOJA</span>
                                                <% } %>
                                            </div>
                                            <div class="condition-info">
                                                <span><%= listing.condition %></span> |
                                                <span><%= listing.is_foil ? 'Foil' : 'Normal' %></span>
                                            </div>
                                            <div class="price-info">
                                                <strong>R$ <%= listing.price.toFixed(2) %></strong>
                                            </div>
                                            <div class="add-to-cart-controls">
                                                <input type="number" class="quantity-input form-control" value="1" min="1" max="<%= listing.quantity %>">
                                                <button class="btn-primary add-final-cart-btn" data-listingid="<%= listing._id %>">+ Carrinho</button>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <p class="no-listings">Nenhum anúncio encontrado para esta carta.</p>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <div class="empty-list-message" style="text-align: center; padding: 4rem 0;">
                <h2>Sua lista está vazia.</h2>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Navegue pelas cartas e clique em "+ Lista" para adicioná-las aqui.</p>
                <a href="/cards/magic" class="btn-primary">Explorar Cartas</a>
            </div>
        <% } %>

        <!-- Resumo do Carrinho -->
        <div id="cart-summary" class="cart-summary">
            <h3>Carrinho</h3>
            <ul id="cart-items-list"></ul>
            <p>Total do Carrinho: R$ <span id="cart-total">0.00</span></p>
            <button id="checkout-btn">Finalizar Compra</button>
        </div>
    </main>

    <div id="add-card-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>Adicionar Carta à Lista</h2>
            <div class="form-group">
                <input type="search" id="modal-search-input" class="form-control" placeholder="Digite o nome da carta...">
            </div>
            <div id="modal-search-results"></div>
        </div>
    </div>

    <div id="optimizer-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>Opções Otimizadas</h2>
            <div id="optimizer-results">
                <p>Calculando as melhores combinações...</p>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
    <script src="/js/main.js"></script> <!-- Arquivo JavaScript -->
</body>
</html>
