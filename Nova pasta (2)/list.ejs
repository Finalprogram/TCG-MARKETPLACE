<%- include('../partials/header') %>

<main class="container list-page">
  <%- include('../partials/navbar') %>

  <!-- BotÃ£o flutuante (opcional) -->
  <a href="#" id="floating-cart-button" class="floating-btn">
    <span class="icon">ðŸ›’</span>
    <span class="badge hidden" id="cart-count">0</span>
  </a>

  <div class="list-header" style="margin-top: 1rem;">
    <h1>Sua Lista</h1>
    <a href="/cards" class="btn btn-primary">+ Adicionar mais cartas</a>
  </div>

  <% 
    // Compat: aceita 'items' (novo) ou 'wantList' (antigo)
    const _list = (typeof items !== 'undefined' && items && items.length) 
      ? items 
      : ((typeof wantList !== 'undefined' && wantList) ? wantList : []);
  %>

  <% if (!_list || _list.length === 0) { %>
    <section class="empty" style="margin: 24px 0;">
      <p>Sua lista estÃ¡ vazia.</p>
      <a class="btn btn-secondary" href="/cards">Explorar Cartas</a>
    </section>
  <% } %>

  <section class="cards-stack">
    <% (_list || []).forEach((item, i) => { 
         const card = item.card || item; 
         const cardId = (card && (card._id || card.id || card.cardId)) || '';
         const vendors = item.vendors || item.listings || [];
         const desired = item.desiredQty || item.quantityWanted || 1;
         const lowest = item.minPrice || item.lowestPrice || (vendors && vendors.length ? vendors[0].price : null);
         const drawerId = `sellers-${cardId || i}`;
    %>
      <article class="list-card" data-card-id="<%= cardId %>">
        <div class="list-card__header">
          <div class="list-card__left">
            <img class="card-thumb" src="<%= card.image_url || card.imageUrl || '/img/card-placeholder.png' %>" alt="<%= card.name || 'Carta' %>">
            <div>
              <h3 class="card-title"><%= card.name %></h3>
              <p class="card-sub">
                <%- (card.set_name || card.setName || card.set || '') %>
                <%- (card.code ? ' â€” [' + card.code + ']' : '') %>
              </p>
              <p class="card-qty">Quantidade desejada: <strong><%= desired %></strong></p>
            </div>
          </div>

          <div class="list-card__right">
            <div class="price-chip">
              <span>A partir de</span>
              <strong><%= (lowest != null) ? ('R$ ' + Number(lowest).toFixed(2)) : 'N/A' %></strong>
            </div>

            <!-- BotÃ£o para abrir/fechar vendedores -->
            <button 
              class="btn btn-outline toggle-sellers-btn" 
              data-toggle="sellers" 
              aria-controls="<%= drawerId %>">
              Ver vendedores â–¾
            </button>

            <!-- Remover item da lista (opcional) -->
            <button class="btn icon-only remove-item" title="Remover" data-remove="<%= cardId %>">âœ•</button>
          </div>
        </div>

        <!-- Gaveta de vendedores (inicia oculta) -->
        <div id="<%= drawerId %>" class="sellers-panel" hidden>
          <!-- Filtros simples (opcionais) -->
          <div class="sellers-filters">
            <select class="filter-select" data-filter="condition">
              <option value="">CondiÃ§Ã£o (todas)</option>
              <option value="novo">(N) Novo</option>
              <option value="normal">Normal</option>
              <option value="danificada">Danificada</option>
            </select>

            <select class="filter-select" data-filter="language">
              <option value="">Idioma (todos)</option>
              <option value="pt">PortuguÃªs</option>
              <option value="en">InglÃªs</option>
              <option value="jp">JaponÃªs</option>
            </select>

            <select class="filter-select" data-filter="location">
              <option value="">Local (todos)</option>
              <option value="br">Brasil</option>
              <option value="latam">LatAm</option>
              <option value="global">Global</option>
            </select>
          </div>

          <!-- Tabela/Lista de vendedores -->
          <div class="sellers-table">
            <div class="sellers-head">
              <span>Vendedor</span>
              <span>CondiÃ§Ã£o</span>
              <span>Idioma</span>
              <span>Disp.</span>
              <span class="right">PreÃ§o</span>
              <span class="right">Qtd.</span>
              <span class="right">AÃ§Ã£o</span>
            </div>

            <div class="sellers-body">
              <% (vendors || []).forEach(v => {
                   // Normaliza campos
                   const available = v.availableQty || v.quantity || 0;
                   const price = Number(v.price || 0);
                   const vendorId = v.vendorId || v._id || v.sellerId || v.seller || '';
                   const sellerName = v.sellerName || (v.seller && (v.seller.username || v.seller.name)) || v.seller || 'Vendedor';
                   const cond = (v.condition || '').toLowerCase();
                   const lang = (v.language || '').toLowerCase();
                   const loc = (v.location || (v.seller && v.seller.country) || '').toLowerCase();
              %>
                <!-- Linha do vendedor com ganchos para o JS -->
                <div class="seller-row vendor-row"
                     data-condition="<%= cond %>"
                     data-language="<%= lang %>"
                     data-location ="<%= loc %>"
                     data-cardid="<%= cardId %>"
                     data-vendorid="<%= vendorId %>"
                     data-price="<%= price %>"
                     data-available="<%= available %>">

                  <span class="seller-name">
                    <%= sellerName %> 
                    <% if (v.seller && v.seller.accountType === 'shop') { %>
                      <span class="shop-badge">LOJA</span>
                    <% } %>
                  </span>

                  <span><%= v.conditionLabel || v.condition || 'â€”' %></span>
                  <span><%= v.languageLabel || v.language || 'â€”' %></span>
                  <span><%= available %></span>

                  <!-- CÃ©lula de preÃ§o marcada para o JS injetar os controles depois -->
                  <span class="right price js-price-cell">R$ <%= price.toFixed(2) %></span>

                  <!-- As duas colunas seguintes (Qtd./AÃ§Ã£o) serÃ£o preenchidas pelo JS:
                       ele injeta [ - 1 + ] e [Adicionar] logo apÃ³s .js-price-cell -->
                  <span class="right placeholder"></span>
                  <span class="right placeholder"></span>
                </div>
              <% }) %>

              <% if (!vendors || vendors.length === 0) { %>
                <div class="no-sellers">Nenhum vendedor encontrado para esta carta.</div>
              <% } %>
            </div>
          </div>
        </div>
      </article>
    <% }) %>
  </section>
</main>

<!-- Garante que seu main.js carregue depois do HTML -->
<script src="/js/main.js"></script>

<%- include('../partials/footer') %>

<!-- Ajuste opcional do botÃ£o flutuante: -->
<script>
  // Se vocÃª usa alguma aÃ§Ã£o custom no botÃ£o flutuante, configure aqui:
  document.getElementById('floating-cart-button')?.setAttribute('data-action','open-cart-modal');
</script>
